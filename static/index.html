<!DOCTYPE html>
<html>
<head>
    <title>Excel Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
        .preview-table {
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Excel File Processor</h1>
        <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
            <div class="mb-3">
                <label for="excelFile" class="form-label">Choose Excel File (.xlsx, .xls)</label>
                <input class="form-control" type="file" id="excelFile" accept=".xlsx,.xls" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        
        <div id="loadingSpinner" class="hidden">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Processing file...</span>
        </div>
        
        <div id="errorAlert" class="alert alert-danger hidden" role="alert"></div>
        
        <div id="resultsSection" class="hidden mt-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Sheets
                        </div>
                        <div class="list-group list-group-flush" id="sheetsList"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span id="sheetNameTitle">Select a sheet</span>
                        </div>
                        <div class="card-body">
                            <div id="sheetPreview"></div>
                            <div class="mt-3">
                                <label for="rowSelect" class="form-label">Select Row:</label>
                                <select class="form-select mb-2" id="rowSelect"></select>
                                <button id="sumRowBtn" class="btn btn-success">Calculate Row Sum</button>
                                <div id="sumResult" class="mt-2 alert alert-info hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const excelFileInput = document.getElementById('excelFile');
            const resultsSection = document.getElementById('resultsSection');
            const sheetsList = document.getElementById('sheetsList');
            const sheetNameTitle = document.getElementById('sheetNameTitle');
            const sheetPreview = document.getElementById('sheetPreview');
            const rowSelect = document.getElementById('rowSelect');
            const sumRowBtn = document.getElementById('sumRowBtn');
            const sumResult = document.getElementById('sumResult');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorAlert = document.getElementById('errorAlert');
            
            let currentSheet = null;
            
            // Handle file upload
            uploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const file = excelFileInput.files[0];
                if (!file) {
                    showError('Please select a file first');
                    return;
                }
                
                // Show loading spinner
                loadingSpinner.classList.remove('hidden');
                errorAlert.classList.add('hidden');
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/upload_excel', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Upload failed');
                    }
                    
                    const data = await response.json();
                    
                    // Show results section
                    resultsSection.classList.remove('hidden');
                    
                    // Populate sheets list
                    sheetsList.innerHTML = '';
                    data.tables.forEach(sheet => {
                        const sheetItem = document.createElement('button');
                        sheetItem.className = 'list-group-item list-group-item-action';
                        sheetItem.textContent = sheet;
                        sheetItem.addEventListener('click', () => loadSheetDetails(sheet));
                        sheetsList.appendChild(sheetItem);
                    });
                    
                    // Show first sheet by default
                    if (data.tables.length > 0) {
                        loadSheetDetails(data.tables[0]);
                    }
                    
                } catch (error) {
                    showError('Error: ' + error.message);
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });
            
            // Load sheet details
            async function loadSheetDetails(sheetName) {
                try {
                    // Update active sheet in the list
                    document.querySelectorAll('#sheetsList button').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === sheetName) {
                            btn.classList.add('active');
                        }
                    });
                    
                    currentSheet = sheetName;
                    sheetNameTitle.textContent = sheetName;
                    
                    // Show loading for sheet details
                    sheetPreview.innerHTML = '<p>Loading data...</p>';
                    sumResult.classList.add('hidden');
                    
                    // Fetch sheet details
                    const response = await fetch(`/get_table_details?table_name=${encodeURIComponent(sheetName)}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to load sheet');
                    }
                    
                    const data = await response.json();
                    
                    // Display sheet preview
                    displayTablePreview(data.preview);
                    
                    // Populate row select
                    rowSelect.innerHTML = '';
                    data.row_names.forEach(row => {
                        const option = document.createElement('option');
                        option.value = row;
                        option.textContent = row;
                        rowSelect.appendChild(option);
                    });
                    
                } catch (error) {
                    showError('Error loading sheet: ' + error.message);
                }
            }
            
            // Display table preview
            function displayTablePreview(data) {
                if (!data || data.length === 0) {
                    sheetPreview.innerHTML = '<p>No data available</p>';
                    return;
                }
                
                let html = '<table class="table table-bordered table-hover preview-table"><thead><tr>';
                
                // Create headers
                for (let i = 0; i < data[0].length; i++) {
                    html += `<th>Column ${i+1}</th>`;
                }
                html += '</tr></thead><tbody>';
                
                // Add rows
                data.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${cell !== null ? cell : ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                sheetPreview.innerHTML = html;
            }
            
            // Calculate row sum
            sumRowBtn.addEventListener('click', async function() {
                if (!currentSheet || !rowSelect.value) {
                    showError('Please select a sheet and row first');
                    return;
                }
                
                try {
                    sumResult.classList.add('hidden');
                    
                    const response = await fetch(
                        `/row_sum?table_name=${encodeURIComponent(currentSheet)}&row_name=${encodeURIComponent(rowSelect.value)}`
                    );
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Calculation failed');
                    }
                    
                    const data = await response.json();
                    
                    sumResult.classList.remove('hidden');
                    sumResult.innerHTML = `
                        <strong>Sum of row "${data.row_name}":</strong> ${data.sum.toFixed(2)}<br>
                        <small>Values: ${data.values.map(v => v.toFixed(2)).join(', ')}</small>
                    `;
                } catch (error) {
                    showError('Error calculating sum: ' + error.message);
                }
            });
            
            // Helper function to show errors
            function showError(message) {
                errorAlert.textContent = message;
                errorAlert.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>